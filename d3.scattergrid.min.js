d3.scattergrid=function(t,e,a){var r=200,n=10,s={top:0,right:0,bottom:30,left:60},i=r*(e.length-1)+s.left+s.right,l=r*(e.length-1)+s.top+s.bottom,o=[],c=[],d=$.bbq.getState("scattergrid"),f=d3.select("body").append("svg").classed("scattergrid",!0).attr("width",i).attr("height",l).style("position","absolute").style("top",0).style("left",0),y=d3.select("body").append("canvas").classed("scattergrid",!0).attr("width",i).attr("height",l).style("position","absolute").style("top",0).style("left",0),g=y.node().getContext("2d"),p=function(t){g.clearRect(0,0,i,l),c.forEach(function(e){e(t)})},u=function(){return!1},h=u,x=d3.select("body").append("svg").classed("scattergrid",!0).attr("width",i).attr("height",l).style("position","absolute").style("top",0).style("left",0),b=function(t,e){var a;return a="log"==t.scale?d3.scale.log():d3.scale.linear(),t.domain?a.domain(t.domain):a.domain(d3.extent(e,function(e){return e[t.key]})),t.nice&&a.nice(),a};e.forEach(function(i,l){var y=b(i,t).range([s.left+r*l+n,s.left+r*(l+1)-n]),u=d3.svg.axis().scale(y).orient("bottom");l<e.length-1&&x.append("g").classed("x axis",!0).attr("transform","translate(0,"+(s.top+r*(e.length-1)-n)+")").call(u).append("text").style("text-anchor","middle").attr("x",s.left+r*(l+.5)).attr("y",30).text(i.key),e.forEach(function(e,u){if(!(l>=u)){var k=b(e,t).range([s.top+r*u-n,s.top+r*(u-1)+n]);if(y.ticks(5).forEach(function(t){f.append("line").classed("x grid",!0).attr("x1",y(t)).attr("y1",k.range()[0]).attr("x2",y(t)).attr("y2",k.range()[1])}),y.ticks(5).forEach(function(t){f.append("line").classed("x grid rule",!0).attr("x1",y(t)).attr("y1",k.range()[0]).attr("x2",y(t)).attr("y2",k.range()[0]+2*n)}),k.ticks(5).forEach(function(t){f.append("line").classed("y grid",!0).attr("x1",y.range()[0]).attr("y1",k(t)).attr("x2",y.range()[1]).attr("y2",k(t))}),u-1>l&&k.ticks(5).forEach(function(t){x.append("line").classed("y grid rule",!0).attr("x1",y.range()[1]).attr("y1",k(t)).attr("x2",y.range()[1]+2*n).attr("y2",k(t))}),0==l){var v=d3.svg.axis().scale(k).orient("left");x.append("g").classed("y axis",!0).attr("transform","translate("+(s.left+n)+",0)").call(v).append("text").attr("transform","rotate(-90)").style("text-anchor","middle").attr("x",-(s.top+r*(u-.5))).attr("y",-40).text(e.key)}c.push(function(a){var r=[],n=[];t.forEach(function(t){a(t)?n.push(t):r.push(t)}),g.fillStyle="blue",r.forEach(function(t){g.fillRect(y(t[i.key])-.5,k(t[e.key])-.5,1,1)}),g.fillStyle="red",n.forEach(function(t){g.fillRect(y(t[i.key])-.5,k(t[e.key])-.5,1,1)})}),x.append("rect").classed("axis",!0).attr("x",s.left+r*l+n).attr("y",s.top+r*(u-1)+n).attr("width",r-2*n).attr("height",r-2*n);var m=d3.svg.brush().x(y).y(k).on("brushstart",function(){o.forEach(function(t){t!==m&&(t.clear(),t.g.call(t))})}).on("brush",function(){var t=m.extent(),r=function(a){return a[i.key]>=t[0][0]&&a[i.key]<=t[1][0]&&a[e.key]>=t[0][1]&&a[e.key]<=t[1][1]};p(r),a&&a(r)}).on("brushend",function(){var t=m.extent();m.empty()?$.bbq.removeState("scattergrid"):$.bbq.pushState({scattergrid:{extent:t,xi:l,yi:u}})});if(d&&d.xi==l&&d.yi==u){var E=d.extent;m.extent(E),h=function(t){return t[i.key]>=E[0][0]&&t[i.key]<=E[1][0]&&t[e.key]>=E[0][1]&&t[e.key]<=E[1][1]}}var S=x.append("g").attr("class","brush").call(m);m.g=S,o.push(m)}})}),p(h),a&&a(h)};